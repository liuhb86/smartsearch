<!DOCTYPE html>
<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="content-type">
<title>BiLSearch</title>
<link rel="icon" href="img/favicon.png" type="image/png" /> 
<link rel="search" type="application/opensearchdescription+xml" href="opensearch.xml" title="Smart Search">
<script src="http://code.jquery.com/jquery-1.8.3.min.js" type="text/javascript">
</script>
<script src="jquery.query-2.1.7.min.js" type="text/javascript"></script>
<script src="jsrender.js" type="text/javascript"></script>
<style>
body, div, ol, li, img {
	margin: 0;
	padding: 0;
}
body {
	overflow: hidden;
}
#resultFrame {
	width: 100%;
	border: none;
	margin: 0;
	padding: 0;
}
#searchBar {
	padding: 2px;
	width : 100%;
	position: absolute;
	background-color: rgba(50,50,50,.5);
}
#queryInput {
	width : 30%;
}
#searchEngines {
	list-style : none;
	display: inline;
	vertical-align : top;
}
#searchEngines .active {
	border: solid 2px white;
}
.search-engine-item {
	display: inline-block;
	cursor : pointer;
	border: solid 2px rgba(0,0,0,0);
	height: 16px;
}
.search-engine-item img {
	height: 20px;
	width : 20px;
}
</style>
</head>
<body>
	<div id="searchBar">
		<input type="text" id="queryInput"></input>
		<button id="searchButton">Search</button>
		<ol id="searchEngines">
		</ol>
	</div>
	<iframe id="resultFrame">
	</iframe>
</body>
<script id="searchEngineTmpl" type="text/x-jsrender" for="searchEngines">
		<li class="search-engine-item" title="{{:title}}" index="{{:#index}}"><img src="{{:icon}}" alt="{{:title}}"></img></li>
</script>

<script type="text/javascript">
window.smartSearch = {};

smartSearch.util = {
	getDomainFromUrl : function (url){
		var match = url && url.match(/:\/\/([^\/]*)/);
		if (match) {
			return match[1];
		} else {
			return null;
		}
	},
	getFaviconUrl : function (domain) {
		return "http://www.google.com/s2/favicons?domain=" + domain;
	}
};
(function(p) {
var self = p.service = {
	config : {
	},
	runtime : {
		engineList : []
	},
	searchEngines : {
		smart : {
			title : "Smart",
			icon : "img/logo.png"
		},
		baidu : { 
			title : "Baidu",
			url : "http://www.baidu.com/s?ie=utf-8&wd="
		},
		bing: {
			title : "Bing",
			url : "http://www.bing.com/search?q="
		},
		google : {
			title : "Google",
			url : "http://www.google.com/custom?ie=utf-8&q="		//Ref to baigoogledu.com for XFrame workaround
		}
	},
	getIconForSearchEngine : function (engine) {
		if (! (engine.icon && engine.icon.length))
			engine.icon = p.util.getFaviconUrl(p.util.getDomainFromUrl(engine.url));
		return engine.icon; 
	},
	chooseEngineByContent : function (query) {
		var i, strEngine, 
			isPureAscii = true;
		for (i = 0; i < query.length; ++i) {
			if (query.charCodeAt(i) > 127) {
				isPureAscii = false;
				break;
			}
		}
		strEngine = isPureAscii ? "google" : "baidu";
		return self.searchEngines[strEngine];
	},
	chooseEngine : function (query) {
		if (self.runtime.activeEngine !== self.searchEngines.smart) 
			return self.runtime.activeEngine;
		return self.chooseEngineByContent(query);
	},
	changeEngineByIndex : function (index) {
		var e = index ? self.runtime.engineList[index] : undefined;
		if (e!== self.runtime.activeEngine) {
			self.runtime.activeEngine = e;
			return true;
		} else {
			return false;
		}
	},
	getSearchUrl : function (query) {
		var navUrl, engine;
		engine = self.chooseEngine(query);
		navUrl = engine.url + encodeURIComponent(query);
		return navUrl;
	},
	init : function () {
		var i, engine;
		for (i in self.searchEngines) {
			engine = self.searchEngines[i];
			engine.id = i;
			self.getIconForSearchEngine(engine);
			self.runtime.engineList.push(engine);
		}
		self.runtime.activeEngine = self.searchEngines.smart;
	}
};
})(smartSearch);

(function (p) {
var self = p.view = {
	setFrameUrl : function (url) { self.$resultFrame[0].src = url; },
	setTitle : function (str) { document.title = str + " - BiLSearch"; },
	setUrlHash : function () { window.location.hash = self.hash.toString(); },
	setUrlParam : function (key, val) {
		if (val)
			self.hash.SET(key,val); 
		else
			self.hash.REMOVE(key);
		self.setUrlHash();
	},
	getUrlParam : function (key) { return self.hash.get(key) || $.query.get(key); },
	getUrlQuery : function () { return self.getUrlParam("q"); },
	setUrlQuery : function (q) { self.setUrlParam("q", q); },
	getUrlEngine : function () { return self.getUrlParam("e"); },
	setUrlEngine : function (e) { self.setUrlParam("e", e=="smart" ? null : e); },
	getQuery : function () { return self.$queryInput.val(); },
	setQuery : function (q) { self.$queryInput.val(q); },
	addSearchEngineIcons : function (engines) {
		$("#searchEngines").append($("#searchEngineTmpl").render(engines));
		self.$searchEngineItems = $(".search-engine-item");
	},
	adjustFrameHeight : function () {
		self.$resultFrame.height(window.innerHeight);
	},
	changeEngine : function (index) {
		var $current;
		self.$activeEngine.removeClass("active");
		if (index) {
			$current = self.$searchEngineItems.filter("[index='"+index+"']");
		} else {
			$current = self.$smartSearchItem;
		}
		$current.addClass("active");
		self.$activeEngine = $current;
	},
	bindEvents : function () {
		$(window).resize(self.adjustFrameHeight);
	},
	init : function () {
		self.hash = $.query.load(window.location.hash);
		self.$resultFrame = $("#resultFrame");
		self.$queryInput = $("#queryInput");
		self.$searchButton = $("#searchButton");
		self.$smartSearchItem = $("#smartSearchItem");
		self.$activeEngine = self.$smartSearchItem;
		self.adjustFrameHeight();
		self.bindEvents();
	}
};
})(smartSearch);

(function (p) {
var self= p.app = {
	service : p.service,
	view : p.view,
	onSearch : function () {
		var query, navUrl;
		query = self.view.getQuery();
		navUrl = self.service.getSearchUrl(query);
		self.view.setTitle(query);
		self.view.setUrlQuery(query);
		self.view.setFrameUrl(navUrl);
	},
	onChangeEngine : function (index) {
		if (!self.service.changeEngineByIndex(index)) return;
		self.view.setUrlEngine(self.service.runtime.activeEngine.id);
		self.view.changeEngine(index);
		self.onSearch();
	},
	bindEvents : function () {
		self.view.$searchButton.click(self.onSearch);
		self.view.$queryInput.keypress(function (event) {
			if	(event.which == 13) {
				self.onSearch();
			}
		});
		self.view.$searchEngineItems.click(function (){
			self.onChangeEngine($(this).attr("index"));
		});
	},
	init : function () {
		self.service.init();
		self.view.init();
		var query;
		self.view.addSearchEngineIcons(self.service.runtime.engineList);
		self.bindEvents();
		query = self.view.getUrlQuery();
		self.service.runtime.query = query;
		self.view.setQuery(query);
		if (query) 
			self.onSearch();
	}
};
})(smartSearch);

$(function (){
	smartSearch.app.init();
});
</script>
</html>
